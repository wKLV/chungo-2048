<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(700, 700, Phaser.AUTO, '', { preload: preload, create: create, update:update });

        function preload () {

            game.load.image('logo', 'background.jpg');
            game.load.image('tile', 'ceramic.png');

        }
        var tileGroup, tiles = [], swiping, canMove, direction, speed = 100, stopped = true;
        function create () {
         //   game.physics.startSystem(Phaser.Physics.ARCADE);
            var logo = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
            tileGroup = game.add.physicsGroup(Phaser.Physics.Arcade);
            for(var i=0; i<4; i++){
                var p = pospx(i+1, i+1);
                var tile = tileGroup.create(p.x, p.y, 'tile');
                tiles[i] = tile;
                game.physics.arcade.enable(tile);
                tile.anchor.setTo(0.5, 0.5);

                var style = {font:"32px Arial", fill:"#aa0000", align:"center"};
                var text = game.add.text(0,0, "0", style);
                text.anchor.set(0.5);
                tiles[i].texts = text;
                tiles[i].points = 1;
           //     tile.body.collideWorldBounds = true;
             //   tile.body.bounce.setTo(1,1);
               // tile.body.velocity.setTo(100,100);

            }
            tileGroup.setAll('body.collideWorldBounds', true);

            logo.anchor.setTo(0.5, 0.5);

        }
        function pospx(x, y){
            return {x:170*x-75, y:170*y-75};
        }

        function pxpos(x, y){
          return {x:Math.ceil(x/175), y:Math.ceil(y/175)};
        }
        function update() {
          stopped =true;
          for(var i=0; i<tiles.length; i++){
            var tile = tiles[i];
              if(tile.body.velocity.x !== 0 || tile.body.velocity.y !== 0) stopped = false;

              tile.texts.text = ""+tile.points;
              if(tile.x < 95) { tile.x = 95; tile.body.velocity.setTo(0,0); }
              else if(tile.x>605){ tile.x = 605; tile.body.velocity.setTo(0,0); }
              if(tile.y < 95) { tile.y = 95; tile.body.velocity.setTo(0,0); }
              else if(tile.y>605) { tile.y = 605; tile.body.velocity.setTo(0,0); }

              tile.texts.x = tile.x; tile.texts.y=tile.y;
          }
          game.physics.arcade.collide(tileGroup, tileGroup, onCollision);

          if (canMove) {
          		canMove = false;

          		for (var i=0; i < tiles.length; i++) {
          			if (direction == 0) {
          				//up
          				tiles[i].body.velocity.y = -speed;
          				tiles[i].body.velocity.x = 0;

          			} else if (direction == 1) {
          				//right
          				tiles[i].body.velocity.x = speed;
          				tiles[i].body.velocity.y = 0;

          			} else if (direction == 2) {
          				//down
          				tiles[i].body.velocity.y = speed;
          				tiles[i].body.velocity.x = 0;

          			} else if (direction == 3) {
          				//left
          				tiles[i].body.velocity.x = -speed;
          				tiles[i].body.velocity.y = 0;
          			}
                stopped = false;
          		}
          	}

          if(stopped) onSwipe();
        	if (swiping){
        		swiping = false;
        		if(firstPointX > lastPointX){

        			checkSwipeX = firstPointX - lastPointX;

        			if ( checkSwipeX >= 150 ) {
        				canMove = true;
        				direction = 3;
        			}

        		} else if(firstPointX < lastPointX){

        			checkSwipeX = lastPointX - firstPointX;

        			if ( checkSwipeX >= 150 ) {
        				canMove = true;
        				direction = 1;
        			}
        		}

        		if(firstPointY > lastPointY){

        			checkSwipeY = firstPointY - lastPointY;

        			if ( checkSwipeY >= 150 ) {
        				canMove = true;
        				direction = 0;
        			}

        		} else if(firstPointY < lastPointY){

        			checkSwipeY = lastPointY - firstPointY;

        			if ( checkSwipeY >= 150 ) {
        				canMove = true;
        				direction = 2;
        			}
        		}
            if(Math.random()>0.7) respawn();
	         }
        }

    function respawn() {
        var p;
        if(direction===0){
          p = pospx(Math.ceil(Math.random()*4), 4);
        }
        else if (direction === 1) {
          p = pospx(1, Math.ceil(Math.random()*4));
        }
        else if(direction===2){
          p = pospx(Math.ceil(Math.random()*4), 1);
        }
        else if (direction === 3) {
          p = pospx(4, Math.ceil(Math.random()*4));
        }
        var tile = tileGroup.create(p.x, p.y, 'tile');

        var i = tiles.length;
        tiles[i] = tile;
        game.physics.arcade.enable(tile);
        tile.anchor.setTo(0.5, 0.5);

        var style = {font:"32px Arial", fill:"#aa0000", align:"center"};
        var text = game.add.text(0,0, "0", style);
        text.anchor.set(0.5);
        tiles[i].texts = text;
        tiles[i].points = 1;
    }

    function onSwipe() {
    	if (Phaser.Point.distance(game.input.activePointer.position, game.input.activePointer.positionDown) > 150 && game.input.activePointer.duration > 100 && game.input.activePointer.duration < 250)
    	{
    		firstPointX = game.input.activePointer.positionDown.x;
    		firstPointY = game.input.activePointer.positionDown.y;

    		lastPointX = game.input.activePointer.position.x;
    		lastPointY = game.input.activePointer.position.y;

    		swiping = true;
  	  }
    }
    function onCollision(a, b) {
      var velx = a.body.velocity.x , vely = a.body.velocity.y;
      if(velx===0) velx = b.body.velocity.x;
      if(vely===0) vely = b.body.velocity.y;

      if(velx>0) velx = 1; else if(velx<0) velx = -1;
      if(vely>0) vely = 1; else if(vely<0) vely = -1;

      a.body.velocity.setTo(0,0);
      b.body.velocity.setTo(0,0);

        var p;
        if (a.position.x > b.position.x) {
          if(velx === 1)
            p = pxpos(a.position.x, a.position.y);
          else if(velx === -1)
            p = pxpos(b.position.x, b.position.y);
         } else if(a.position.x < b.position.x) {
          if(velx=== 1)
            p = pxpos(b.position.x, b.position.y);
          else if(velx === -1)
            p = pxpos(a.position.x, a.position.y);
          }
          else if (a.position.y > b.position.y) {
            if(vely === 1)
              p = pxpos(a.position.x, a.position.y);
            else if(vely === -1)
              p = pxpos(b.position.x, b.position.y);
           } else if(a.position.y < b.position.y) {
            if(vely=== 1)
              p = pxpos(b.position.x, b.position.y);
            else if(vely === -1)
              p = pxpos(a.position.x, a.position.y);
            }
    //    if (a.position.y > b.position.y && vely=== 1) p = pxpos(b.position.x, b.position.y);
  //      else if(a.position.y < b.position.y && vely=== -1) p = pxpos(a.position.x, a.position.y);

      //  var ap = pxpos(a.position.x, a.position.y), bp = pxpos(b.position.x, b.position.y);
      var ap = pxpos(a.x, a.y), ap = pospx(ap.x, ap.y);
      a.x = ap.x, a.y = ap.y;
      var bp = pxpos(b.x, b.y), bp = pospx(bp.x, bp.y);
      b.x = bp.x, b.y = bp.y;


  //    b.position = pospx(b.x, b.y);

        if(a.points === b.points){
          a.points *= 2;

          a.position = pospx(p.x, p.y)

          var i = tiles.indexOf(b);
          tiles.splice(i, 1);

          b.texts.kill();
          b.kill();
          respawn();
      }
    }
  };

    </script>

    </body>
</html>
